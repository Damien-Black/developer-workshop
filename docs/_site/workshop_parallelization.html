<!DOCTYPE html>
<head>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="">
<meta name="keywords" content=" getting_started">
<title>Parallelization | DNAnexus Developer Workshop</title>
<link rel="stylesheet" href="css/syntax.css">


<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
<!--<link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">-->
<link rel="stylesheet" href="css/modern-business.css">
<link rel="stylesheet" href="css/lavish-bootstrap.css">
<link rel="stylesheet" href="css/customstyles.css">
<link rel="stylesheet" href="css/theme-blue.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
<script src="js/jquery.navgoco.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/2.0.0/anchor.min.js"></script>
<script src="js/toc.js"></script>
<script src="js/customscripts.js"></script>

<link rel="shortcut icon" href="images/favicon.ico">

<!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->

<link rel="alternate" type="application/rss+xml" title="" href="http://www.dnanexus.comfeed.xml">

    <script>
        $(document).ready(function() {
            // Initialize navgoco with default options
            $("#mysidebar").navgoco({
                caretHtml: '',
                accordion: true,
                openClass: 'active', // open
                save: false, // leave false or nav highlighting doesn't work right
                cookie: {
                    name: 'navgoco',
                    expires: false,
                    path: '/'
                },
                slide: {
                    duration: 400,
                    easing: 'swing'
                }
            });

            $("#collapseAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', false);
            });

            $("#expandAll").click(function(e) {
                e.preventDefault();
                $("#mysidebar").navgoco('toggle', true);
            });

        });

    </script>
    <script>
        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        })
    </script>
    

</head>
<body>
<!-- Navigation -->
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container topnavlinks">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="fa fa-lg navbar-brand" href="index.html">&nbsp;<span class="projectTitle"> DNAnexus Connect Developer Workshop</span></a>
        </div>
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <!-- entries without drop-downs appear here -->
                
                
                
                <!-- entries with drop-downs appear here -->
                <!-- conditional logic to control which topnav appears for the audience defined in the configuration file.-->
                
                
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">DNAnexus Resources<b class="caret"></b></a>
                    <ul class="dropdown-menu">
                        
                        
                        <li><a href="https://platform.dnanexus.com" target="_blank">DNAnexus Platform</a></li>
                        
                        
                        
                        <li><a href="https://wiki.dnanexus.com" target="_blank">DNAnexus Wiki</a></li>
                        
                        
                    </ul>
                </li>
                
                
                
                <!--comment out this block if you want to hide search-->
                <li>
                    <!--start search-->
                    <div id="search-demo-container">
                        <input type="text" id="search-input" placeholder="search...">
                        <ul id="results-container"></ul>
                    </div>
                    <script src="js/jekyll-search.js" type="text/javascript"></script>
                    <script type="text/javascript">
                            SimpleJekyllSearch.init({
                                searchInput: document.getElementById('search-input'),
                                resultsContainer: document.getElementById('results-container'),
                                dataSource: 'search.json',
                                searchResultTemplate: '<li><a href="{url}" title="Parallelization">{title}</a></li>',
                    noResultsText: 'No results found.',
                            limit: 10,
                            fuzzy: true,
                    })
                    </script>
                    <!--end search-->
                </li>
            </ul>
        </div>
        </div>
        <!-- /.container -->
</nav>

<!-- Page Content -->
<div class="container">
    <div class="col-lg-12">&nbsp;</div>
    <!-- Content Row -->
    <div class="row">
        <!-- Sidebar Column -->
        <div class="col-md-3">

          


<ul id="mysidebar" class="nav">
    <li class="sidebarTitle">Developer Workshop </li>
    
    
    
    <li>
        <a href="#">Workshop Topics</a>
        <ul>
            
            
            
            <li><a href="index.html">0. Welcome</a></li>
            
            
            
            
            
            
            <li><a href="workshop_getting_started.html">1. Getting Started</a></li>
            
            
            
            
            
            
            <li><a href="workshop_organizing_the_pipeline.html">2. Organizing the Pipeline</a></li>
            
            
            
            
            
            
            <li><a href="workshop_do_you_need_an_applet.html">3. Do You Need an Applet?</a></li>
            
            
            
            
            
            
            <li><a href="workshop_basic_applet_structure.html">4. Basic Applet Structure</a></li>
            
            
            
            
            
            
            <li><a href="workshop_debugging_and_error_handling.html">5. Debugging and Error Handling</a></li>
            
            
            
            
            
            
            <li><a href="workshop_improving_execution.html">6. Improving Execution</a></li>
            
            
            
            
            
            
            <li><a href="workshop_improving_file_io.html">7. Improving File IO</a></li>
            
            
            
            
            
            
            <li class="active"><a href="workshop_parallelization.html">8. Parallelization</a></li>
            
            
            
            
            
            
            <li><a href="workshop_distributed_applets.html">9. Distributed Applets</a></li>
            
            
            
            
            
            
            <li><a href="workshop_handling_complex_dependencies.html">10. Handling Complex Dependencies</a></li>
            
            
            
            
        </ul>
        
        
        
        <!-- if you aren't using the accordion, uncomment this block:
           <p class="external">
               <a href="#" id="collapseAll">Collapse All</a> | <a href="#" id="expandAll">Expand All</a>
           </p>
           -->
    </li>
</ul>
</div>

<!-- this highlights the active parent class in the navgoco sidebar. this is critical so that the parent expands when you're viewing a page. This must appear below the sidebar code above. Otherwise, if placed inside customscripts.js, the script runs before the sidebar code runs and the class never gets inserted.-->
<script>$("li.active").parents('li').toggleClass("active");</script>

    <!-- Content Column -->
    <div class="col-md-9">
        <div class="post-header">
   <h1 class="post-title-main">Parallelization</h1>
</div>



<div class="post-content">

   

    
    
<!-- this handles the automatic toc. use ## for subheads to auto-generate the on-page minitoc. if you use html tags, you must supply an ID for the heading element in order for it to appear in the minitoc. -->
<script>
$( document ).ready(function() {
  // Handler for .ready() called.

$('#toc').toc({ minimumHeaders: 0, listType: 'ul', showSpeed: 0, headers: 'h2,h3,h4' });

/* this offset helps account for the space taken up by the floating toolbar. */
$('#toc').on('click', 'a', function() {
  var target = $(this.getAttribute('href'))
    , scroll_target = target.offset().top

  $(window).scrollTop(scroll_target - 10);
  return false
})
  
});
</script>

<div id="toc"></div>

    

    

    

    

  <p>By “parallelization”, we mean running processes in parallel within a single worker
to take advantage of multiple CPUs.</p>

<h2 id="setting-tool-parameters">8.0 Setting Tool Parameters</h2>

<p>The most obvious way to parallelize your applet is to make sure that tools that already
can take advantage of multiple CPUs are set to do so. For hisat2, there is a <code class="highlighter-rouge">-p &lt;proc&gt;</code>
parameter that tells it the number of processes to use. Generally, you want to have a tool
run using all the CPUs available on whatever instance it is running on, so rather than
hard coding the number of processes, you should use <code class="highlighter-rouge">nproc</code> or <code class="highlighter-rouge">multiprocessing.cpu_count()</code>
in bash and python, respectively.</p>

<ul id="profileTabs" class="nav nav-tabs">
    <li class="active"><a href="#python" data-toggle="tab">python</a></li>
    <li><a href="#bash" data-toggle="tab">bash</a></li>
</ul>
<div class="tab-content">
  <div role="tabpanel" class="tab-pane active" id="python">
<pre class="highlight"><code><span class="n">hisat2_cmd_template</span> <span class="o">=</span> <span class="p">(</span><span class="s">"hisat2 --dta -p {nproc} -x {index_basename} -1 {mate1_fastq} "</span>
                        <span class="s">"-2 {mate2_fastq}"</span><span class="p">)</span>
<span class="n">hisat2_cmd</span> <span class="o">=</span> <span class="n">hisat2_cmd_template</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">nproc</span><span class="o">=</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span>
    <span class="n">index_basename</span><span class="o">=</span><span class="n">index_basename</span><span class="p">,</span>
    <span class="n">mate1_fastq</span><span class="o">=</span><span class="n">inputs_dict</span><span class="p">[</span><span class="s">"mate1_fastqgz_path"</span><span class="p">][</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s">".gz"</span><span class="p">)],</span>
    <span class="n">mate2_fastq</span><span class="o">=</span><span class="n">inputs_dict</span><span class="p">[</span><span class="s">"mate2_fastqgz_path"</span><span class="p">][</span><span class="mi">0</span><span class="p">][:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="s">".gz"</span><span class="p">)])</span>
</code></pre>

  </div>
  <div role="tabpanel" class="tab-pane" id="bash">

<pre class="highlight"><code>hisat2 --dta -p <span class="s2">"</span><span class="k">$(</span>nproc<span class="k">)</span><span class="s2">"</span> -x <span class="nv">$index_basename</span> -1 <span class="s2">"</span><span class="nv">$mate1_fastq_path</span><span class="s2">"</span> -2 <span class="s2">"</span><span class="nv">$mate2_fastq_path</span><span class="s2">"</span> -S hisat2_output.sam
</code></pre>
  
  </div>
</div>

<h2 id="parallelization-in-bash">8.1 Parallelization in Bash</h2>

<p>Commands can be run in parallel in bash by adding a <code class="highlighter-rouge">&amp;</code> symbol at the end of the command. So if we had
this line in our script</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="o">(</span> dx cat <span class="s2">"</span><span class="nv">$mate1_fastqgz</span><span class="s2">"</span> | gunzip &gt; <span class="s2">"</span><span class="nv">$mate1_fastq_path</span><span class="s2">"</span> <span class="o">)</span> &amp;
</code></pre>
</div>

<p>the download and decompression would begin, but the script would not wait for it to complete. Instead,
it will move on to the next line in the script. If we later need to be sure that this process is
finished before we continue, we can use the <code class="highlighter-rouge">wait</code> command along with the id of the process.</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code><span class="o">(</span> dx cat <span class="s2">"</span><span class="nv">$mate1_fastqgz</span><span class="s2">"</span> | gunzip &gt; <span class="s2">"</span><span class="nv">$mate1_fastq_path</span><span class="s2">"</span> <span class="o">)</span> &amp;
<span class="nv">download_pid</span><span class="o">=</span><span class="nv">$!</span>

...

<span class="nb">wait</span> <span class="s2">"</span><span class="nv">$download_pid</span><span class="s2">"</span>
</code></pre>
</div>

<p>Alternatively, we could use the <code class="highlighter-rouge">wait -n</code> command with will way for <em>any</em> background process to finish
and return its exit status.</p>

<div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Anti-Pattern:</b> There are two forms of <code class="highlighter-rouge">wait</code> that are dangerous. The first is a <code class="highlighter-rouge">wait</code> with no process IDs. This will wait for all background jobs to finish, but it will ignore any errors. Similarly, <code class="highlighter-rouge">wait &lt;pid1&gt; &lt;pid2&gt; ...</code> with multiple process IDs will ignore errors in any process except the last one.</div>

<p>Putting this together, we could parallelize the download of the two FASTQ files at the beginning
of the hisat2 applet script:</p>

<div class="language-shell highlighter-rouge"><pre class="highlight"><code>    <span class="nv">mate1_fastq_path</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">mate1_fastqgz_path</span><span class="p">%.gz</span><span class="k">}</span><span class="s2">"</span>
    mkdir -p <span class="s2">"</span><span class="k">$(</span>dirname <span class="s2">"</span><span class="nv">$mate1_fastq_path</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
    <span class="o">(</span> dx cat <span class="s2">"</span><span class="nv">$mate1_fastqgz</span><span class="s2">"</span> | gunzip &gt; <span class="s2">"</span><span class="nv">$mate1_fastq_path</span><span class="s2">"</span> <span class="o">)</span> &amp;

    <span class="nv">mate2_fastq_path</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">mate2_fastqgz_path</span><span class="p">%.gz</span><span class="k">}</span><span class="s2">"</span>
    mkdir -p <span class="s2">"</span><span class="k">$(</span>dirname <span class="s2">"</span><span class="nv">$mate2_fastq_path</span><span class="s2">"</span><span class="k">)</span><span class="s2">"</span>
    <span class="o">(</span> dx cat <span class="s2">"</span><span class="nv">$mate2_fastqgz</span><span class="s2">"</span> | gunzip &gt; <span class="s2">"</span><span class="nv">$mate2_fastq_path</span><span class="s2">"</span> <span class="o">)</span> &amp;

    <span class="nb">wait</span> -n
    <span class="nb">wait</span> -n
</code></pre>
</div>

<p>This will download both files and extract them in parallel. Then when both are finished, the
script will continue.</p>

<div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Anti-Pattern:</b> Do not try to run many downloads or uploads in parallel. <code class="highlighter-rouge">dx download</code> and <code class="highlighter-rouge">dx upload</code> each parallelize file transfer internally, so running many of them in parallel stresses the platform and can degrade performance.</div>

<p>Finally, though it is beyond the scope of this workshop, <a href="https://www.gnu.org/software/parallel/">GNU Parallel</a> is a flexible tool
for running commands in parallel.</p>

<h2 id="parallelization-in-python">8.2 Parallelization in Python</h2>

<p>The first way to parallelize commands in python is to use <code class="highlighter-rouge">subprocess.Popen</code>, whic will return immediately. Then, later you
use <code class="highlighter-rouge">subprocess.Popen.wait()</code> to wait for the command to complete. This is analogous to <code class="highlighter-rouge">&amp;</code> and <code class="highlighter-rouge">wait</code> in bash. Remember
to check the return codes of the commands:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="n">gunzip_proc_1</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">"gunzip"</span><span class="p">,</span> <span class="n">inputs_dict</span><span class="p">[</span><span class="s">"mate1_fastqgz_path"</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
<span class="n">gunzip_proc_2</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">"gunzip"</span><span class="p">,</span> <span class="n">inputs_dict</span><span class="p">[</span><span class="s">"mate2_fastqgz_path"</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>

<span class="n">gunzip_proc_1</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
<span class="n">gunzip_proc_2</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

<span class="k">if</span> <span class="nb">any</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="n">gunzip_proc_1</span><span class="p">,</span> <span class="n">gunzip_proc_2</span><span class="p">]]):</span>
    <span class="k">raise</span> <span class="n">dxpy</span><span class="o">.</span><span class="n">AppError</span><span class="p">(</span><span class="s">"Gunzipping FASTQ files failed."</span><span class="p">)</span>
</code></pre>
</div>

<p>The second way is to use the <code class="highlighter-rouge">multiprocessing</code> module. There are many ways to use this module, but the
most frequent in DNAnexus applets is to use a <code class="highlighter-rouge">multiprocessing.Pool</code>, which creates pool of processes
that can run functions in parallel.</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">unzip_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">([</span><span class="s">"gunzip"</span><span class="p">,</span> <span class="n">file_path</span><span class="p">])</span>
    <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">()</span>

<span class="nd">@dxpy.entry_point</span><span class="p">(</span><span class="s">"main"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">hisat2_index_targz</span><span class="p">,</span> <span class="n">mate1_fastqgz</span><span class="p">,</span> <span class="n">mate2_fastqgz</span><span class="p">):</span>

    <span class="c"># First, download all the input files to local storage</span>
    <span class="n">inputs_dict</span> <span class="o">=</span> <span class="n">dxpy</span><span class="o">.</span><span class="n">download_all_inputs</span><span class="p">()</span>

    <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">()</span> 
    <span class="n">pool</span><span class="o">.</span><span class="nb">map</span><span class="p">(</span><span class="n">unzip_file</span><span class="p">,</span> <span class="p">[</span><span class="n">inputs_dict</span><span class="p">[</span><span class="s">"mate1_fastqgz_path"</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">inputs_dict</span><span class="p">[</span><span class="s">"mate2_fastqgz_path"</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
</code></pre>
</div>

<p>In this code, the two fastq.gz paths are submitted to the <code class="highlighter-rouge">unzip_file1</code> function in parallel.</p>

<div class="alert alert-warning" role="alert"><i class="fa fa-warning"></i> <b>Anti-Pattern:</b> Do not run <code class="highlighter-rouge">subprocess.check_call</code> or <code class="highlighter-rouge">subprocess.check_output</code> using <code class="highlighter-rouge">multiprocessing</code> unless it is wrapped in a <code class="highlighter-rouge">try</code>-<code class="highlighter-rouge">except</code> block that will raise a bare <code class="highlighter-rouge">Exception</code>. Otherwise, if the command fails, the script will hang indefinitely.</div>



    <div class="tags">
        
    </div>

    

</div>

<hr class="shaded"/>

<footer>
            <div class="row">
                <div class="col-lg-12 footer">
               &copy;2016 DNAnexus. All rights reserved. <br />
 Site last generated: Sep 29, 2016 <br />
<p><img src="images/company_logo.png" alt="Company logo"/></p>
                </div>
            </div>
</footer>


    </div>
    <!-- /.row -->
</div>
<!-- /.container -->
    </div>

</body>

</html>